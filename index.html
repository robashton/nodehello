

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
	<head><title>
	Rob Ashton
</title><meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta content="Rob Ashton's blog - OSS .NET, better practises, TDD, RavenDB, NoSql, NHibernate" name="description" />
<meta content="Rob Ashton, ASP.NET, MVC, .NET, C#, VB.NET, NHibernate, Development" name="keywords" />
<meta name="author" content="Rob Ashton" />
<meta name="Generator" content="Subtext Version 2.5.0.3" />
<link id="RSSLink" title="RSS" type="application/rss+xml" rel="alternate" href="http://internal.codeofrob.com/rss.aspx" />
<link type="text/css" rel="stylesheet" href="/Skins/RobAshtonSimples/style.css" />
<link id="CustomCss" type="text/css" rel="stylesheet" href="/customcss.aspx" /><link id="Rsd" rel="EditURI" type="application/rsd+xml" title="RSD" href="http://internal.codeofrob.com/rsd.xml.ashx" /><link id="wlwmanifest" rel="wlwmanifest" type="application/wlwmanifest+xml" href="/wlwmanifest.xml.ashx" /><link id="opensearch" rel="search" type="application/opensearchdescription+xml" href="/opensearchdesc.xml.ashx" Title="Rob Ashton" />
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
		<script type="text/javascript" src="/Scripts/common.js"></script>
		<script type="text/javascript">
			var subtextAllowedHtmlTags = ['a', 'b', 'strong', 'blockquote', 'p', 'i', 'em', 'u', 'strike', 'super', 'sub', 'code'];
		</script>
		<link rel="openid.server" href="http://www.myopenid.com/server" /><link rel="openid.delegate" href="http://robashton.codeofrob.com/" /></head>
	<body>
		<form name="Form1" method="post" action="" id="Form1">
<input type="hidden" name="__VIEWSTATE" id="
__VIEWSTATE" value="" />


<script src="/ScriptResource.axd?d=dFgXLE41dua0FHbNJCpczZLQCSu0DqBFZe-Sdw-Tmoy5ypR2jI_qGGGuQ1-Qoagb8whgnCxLofypo6Kd7apuE8pUIbNqrQkF3RENxCnUYQmF9Kt2chGyNk2TZH18naGCUG_KJxf_cct6Nn8s8R-cNW_HPFo1&amp;t=ffffffffce114dca" type="text/javascript"></script>
<div style="position: fixed; top: 0; left: 0; width: 200px; height: 100%; pointer-events:none; background: url(http://www.tomscott.com/buntify/bunting_l.png) top left repeat-y;"></div>
<div style="position: fixed; top: 0; right: 0; width: 200px; height: 100%; pointer-events:none; background: url(http://www.tomscott.com/buntify/bunting_r.png) top right repeat-y;"></div>
<div style="position: fixed; bottom: 0; left: 0; width: 100%; height: 200px; pointer-events:none; background: url(http://www.tomscott.com/buntify/bunting_d.png) bottom center no-repeat;"></div>
<embed autostart="true" loop="true" volume="100" hidden="false" src="http://www.tomscott.com/buntify/rulebrit.mid"></embed>
            
			

<div id="container">

	<div id="summary">
		<div id="header">
			<h1><a href="http://codeofrob.com">Rob Ashton</a></h1>
			<p>Coding for fun and profit - sometimes pausing to say "hello world"</p>
		</div>
		<div id="summary-content">
					<img src="/img/profile.jpg" />

					<p>I am a freelance software consultant originally from the UK, but currently operating in Belgium.</p>
					<p>I primarily create applications against .NET technologies, but I'm not afraid of the world outside - I run Linux on my personal computers, compile my personal code against Mono and this site is written in Javascript with node.js.</p>
					<p>When not working, I am learning, and usually end up contributing to various open source projects as a result of that.</p>
					<p>I often can be found doing talks on these things - either at local user groups or at the international level, I can usually be bribed with coffee or food.</p>
					<p>I can be contacted at <a href="mailto:robashton@codeofrob.com">robashton@codeofrob.com</a>, unsolicited agency e-mails without meaningful information in them get junked.</p>
		</div>
		
		<div id="summary-blocks">
			<div class="summary-block">
				<a href="http://codeofrob.com/">Home</a>
			</div>
			<div class="summary-block">
				<a href="http://twitter.com/robashton">twitter/robashton</a>
			</div>
			<div class="summary-block">
				<a href="http://github.com/robashton">github/robashton</a>
			</div>
		</div>
		
	</div>
	
    <div id="content">
		<div id="header-post">
			<div id="main-section">
				
					
		
	<div class="day">
		<div class="date">
			<a id="_32e39ae98efa_HomePageDays_DaysList_ctl00_DayItem_ImageLink" title="Click to see entries for this day." title="Day Archive" href="/archive/2011/04/04.aspx" style="display:inline-block;">Monday, April 04, 2011</a>
		</div>
	
	
			<div class="post">
				<div class="title">
					<a id="_32e39ae98efa_HomePageDays_DaysList_ctl00_DayItem_DayList_ctl00_TitleUrl" title="Click To View Entry." href="/archive/2011/04/04/static-analysis-of-simple-data-code-to-generate-databases.aspx">Static analysis of Simple.Data code to generate databases</a>
				</div>
				<div class="body">
					<p>The dynamic keyword in C#4 has been put to some good use already - and has attracted a few detractors (probably because dynamic is to C# as generic is to Java), but the fact that the dynamic keyword compiles down to simple reflection over System.Object does present some interesting possibilities over its more pure counterparts.</p>

<p>I had this thought at the weekend whilst doing something completely unrelated, and a brief Google suggested nobody else has bothered doing it with Mark Rendle's <a href="https://github.com/markrendle/Simple.Data">Simple.Data</a> yet, so here I am with a proof of concept scribbled down after a couple of hours work this evening.</p>

<p>Given the following code:</p>

<script src="https://gist.github.com/902388.js?file=Model.cs"></script>

<p>I want to end up with a database table that looks like:</p>

<script src="https://gist.github.com/902388.js?file=database.sql"></script>

<p>Looking at it, this is actually quite a simple problem, and we have two possible solutions to follow if a as a user, we are to do this without writing any further code on top of this.</p>

<ul>
<li>Create/modify the database as the code is executed</li>
<li>Analyse the compiled IL and figure it out from there</li>
</ul>

<p>Both have their merits and cons (and some cons are definitely shared hah), but from an accessibility point of view being able to do either of these would be pretty "cool"</p>

<p>I'm going for option 2, because I haven't done any IL in a while and want to remind folks that I'm not just a JS monkey, but still care about those .NET leanings too ;-)</p>

<p>Looking at the above code, as a user we can work out that the various columns and tables exist, and their types, so this should mean we can do the same programnatically against the compiled IL.</p>

<p>Let's look at the compiled IL for the first method as dumped out with Mono.Cecil in my immediate Window:</p>

<script src="https://gist.github.com/902388.js?file=gistfile10.cs"></script>

<p>Okay, that's quite daunting, but breaking it down we can easily understand what is going on (I haven't read any docs, I just read the IL and figured it out, so I could be wrong :)</p>

<ul>
<li>First up, we look at a compiled generated static field and if it's present we skip forward by about 30 instructions</li>
<li>If it's not present, we load up the name of our method call (FindByUsername) and do some reflection to get information about that method call</li>
<li>We then do the same with the property access (Users)</li>
<li>Arriving at the point we would have skipped ahead to if those values had been present, we realise they are cached information about the calls to the "Object", only loaded once (sensible as Reflection is expensive yeah?</li>
<li>At this point, we can safely load up the arguments into the stack and make a call via the Callvirt to the cached reflection information on the DB object</li>
</ul>

<p>This is nice and simple, the only information we haven't got for sure is that those dynamic calls are actually being made to a SimpleData object because it's just a System.Object once compiled. I figure it might be possible to trace through the code to find at what point that object was actually created via the Open call, but that's way beyond the scope of this blog post.</p>

<p>As for analysing this, we have Mono.Cecil so may as well write a feature test to try our initial play out.</p>

<script src="https://gist.github.com/902388.js?file=FeatureTest.cs"></script>

<p>I'm not going to be clever about this, as it's just a play-about, so let's dive in and see what information we can find in the assembly - to do this we enumerate the types and pass them into some type of scanner.</p>

<script src="https://gist.github.com/902388.js?file=ModelScanner.cs"></script>

<p>We then have a look at all the methods on that type (duh)</p>

<script src="https://gist.github.com/902388.js?file=MethodScanning.cs"></script>

<p>The important information is found in the method call, and the important stuff we want to look for in a method is (for now):</p>

<ul>
<li>Are there any dynamic method calls made?</li>
<li>Are there any references to cached fields (Callsites)</li>
</ul>

<p>With this in mind, I can think about how to identify these things</p>

<p>Looking at whether we have any method calls (returning references to those instructions - we just look for any call virts to an Invoke method (This is hardly fail-safe, but it'll easily do for that test)</p>

<script src="https://gist.github.com/902388.js?file=ExtractDynamicMethodCallInstructions.cs"></script>

<p>Looking at any cached references to reflected data, again we just look for a loading of a field, the subsequent "goto", and check the type of the field (Callsite)</p>

<script src="https://gist.github.com/902388.js?file=ExtractInitialReflectedCachedFieldReferenceInstructions.cs"></script>

<p>I can use these methods to get me information about what is going on here, and just check we're in a method that actually does something similar to what we're interested in.</p>

<script src="https://gist.github.com/902388.js?file=Check.cs"></script>

<p>The references to those fields will yield in interesting information about the table/column we are dealing with in Simple.Data, that is - the names of those objects.</p>

<p>I find this by going to that instruction and looking for the inevitable call to Ldstr, loading the name of the method call/property access onto the stack before making the reflection call.</p>

<script src="https://gist.github.com/902388.js?file=FieldNames.cs"></script>

<p>So far so good, now I just need the type of the argument passed into the call, and I achieve that by looking at the arguments being loaded into the actual method call</p>

<p>Can you say hacky? I just look at the previous instruction and if it's a ldstr I know the argument is a string :)</p>

<script src="https://gist.github.com/902392.js?file=methodssearch.cs"></script>

<p>All that is left is the putting together of this information into the model we're building.</p>

<script src="https://gist.github.com/902392.js?file=parsing%20the%20data.cs"></script>

<p>This gives me an in memory model of the database, with the name of the table and the column we've found - creating a DB creation script from this is a trivial task left to the imagination by the reader (My Sql is awful man!)</p>

<p>This is where I stopped as I don't have much time to go further tonight, if anybody wants to fork the repository and carry on where I left off, it can be found here: <a href="https://github.com/robashton/Simple.Data.Generation">https://github.com/robashton/Simple.Data.Generation</a></p>

<p>Clearly the rest of the work takes the following path if it was to be continued:</p>

<ul>
<li>Check for all the other types of 'const' to be passed into Simple.Data method calls</li>
<li>Check for arguments/local variables being passed into the Simple.Data method calls</li>
<li>Allow for multiple arguments to Simple.Data method calls</li>
<li>Deal with other types of Simple.Data method call other than FindBy</li>
<li>Deal with dynamic operations being passed to other dynamic operations (Simple.Data does this)</li>
</ul>

<p>Is this actually a good idea? Possibly? Possibly not? I haven't read about the implementation of dynamic behind the scenes by the compiler (literally, not at all) - and don't know how much is left up the compiler when choosing how to do it (Looking at those cached fields...), and this particular script makes quite a lot of assumptions about this.</p>

<p>As an example of what implementing the dynamic key word on top of a statically typed language and runtime brings to us though, it's quite powerful - and it would be interesting to see it pushed further.</p>

<p>Thoughts?</p>


				</div>
				<div class="info">
					posted @ <a href="/archive/2011/04/04/static-analysis-of-simple-data-code-to-generate-databases.aspx" title = "Permanent link to this post">Monday, April 04, 2011 9:57 PM</a> | <a href="/archive/2011/04/04/static-analysis-of-simple-data-code-to-generate-databases.aspx#feedback" title = "comments, pingbacks, trackbacks" class="comments">Feedback (9)</a> | Filed Under [
		<a id="_32e39ae98efa_HomePageDays_DaysList_ctl00_DayItem_DayList_ctl00_Categories_CatList_ctl01_Link" title="" href="/category/7.aspx">General</a>
	]

				</div>
			</div>
		

</div>
	
		
	<div class="day">
		<div class="date">
			<a id="_32e39ae98efa_HomePageDays_DaysList_ctl01_DayItem_ImageLink" title="Click to see entries for this day." title="Day Archive" href="/archive/2011/03/25.aspx" style="display:inline-block;">Friday, March 25, 2011</a>
		</div>
	
	
			<div class="post">
				<div class="title">
					<a id="_32e39ae98efa_HomePageDays_DaysList_ctl01_DayItem_DayList_ctl00_TitleUrl" title="Click To View Entry." href="/archive/2011/03/25/cloud9-on-cygwin-with-node-and-npm.aspx">Cloud9 on Cygwin with Node and Npm</a>
				</div>
				<div class="body">
					<p>If for one reason or another you haven't got a Linux box available and you're using Cygwin to run Node and such, then you probably want a good editor/debugger to go along with this and provide a tolerable experience comparable with that on a more native platform.</p>
<p>Cloud9 is pretty darned cool, and although the hosted version lacks stability with the git integration and various other things, the downloadable and hostable version is pretty much The Thing to use when dealing with large numbers of files in a fully fledged javascript client/server app.</p>
<p>At the moment however, if you want to use the latest node with the latest cloud9, there are a few issues, and getting this scenario working under Windows takes a tiny bit of manual effort.</p>
<ul>
    <li>Install Cygwin.</li>
    <li>Install Git (using Cygwin setup)</li>
    <li>Install Curl (using Cygwin setup)</li>
    <li>Then run Cygwin.</li>
</ul>
<p>That leaves us in a place to install the latest version of Node:</p>
<pre>git clone git://github.com/joyent/node.git<br />cd node<br />./configure<br />make &amp;&amp; make install<br /></pre>
<p>If during the configuration step you're told that you're missing a component, run the Cygwin setup and install that component. Some of the names are a bit different, but googling suffices for everything here - you basically want openssl-dev and a c++ compiler - it didn't ask me for much more than that.</p>
<p>Next up, you want NPM, this is nice and easy</p>
<pre>curl http://npmjs.org/install.sh | sh</pre>
<p>When this has finished chugging, you should be sat in Cygwin wondering what to do next, and the answer is - install Cloud9!</p>
<pre>npm install cloud9</pre>
<p>Now, in an ideal world this would work (and in the future, if you're reading this in the future, hi!) it probably will work at this point - but at the moment you're going to have to re-build one of the components for cloud9 and copy that over to the correct location.</p>
<p>Pop into the Cygwin setup tool and install libxml2-devel</p>
<p>Then from Cygwin perform the following:</p>
<pre>git clone https://github.com/ajaxorg/o3.git<br />cd o3<br />./tools/node_modules_build<br />cp build/default/o3.node /usr/local/lib/node/cloud9/support/jsdav/support/node-o3-xml/lib/o3-xml/<br /></pre>
<p>Now if you go to a folder with a pile of javascript files, you can run cloud9 by typing.</p>
<pre>cloud9</pre>
<p>The fruits of this labour should look something like this:</p>
<p><a href="/images/internal_codeofrob_com/cloud9.png"><img height="392" width="600" src="/images/internal_codeofrob_com/cloud9.png" alt="" /></a></p>
<p>Now you can run/debug/manage all your writings inside your browser - ace stuff.</p>
<p> </p>
<p>Credits go to a chap called <a href="http://gratdevel.blogspot.com/2011/03/easier-way-of-setting-up-cloud9-on.html">Neil Kerkin</a> who I stole this from and ported it into Cygwin so I could do JS if caught short offline on my windows laptop. (I've done likewise on my main Ubuntu machine).</p>
<p><br />
</p>
				</div>
				<div class="info">
					posted @ <a href="/archive/2011/03/25/cloud9-on-cygwin-with-node-and-npm.aspx" title = "Permanent link to this post">Friday, March 25, 2011 2:16 PM</a> | <a href="/archive/2011/03/25/cloud9-on-cygwin-with-node-and-npm.aspx#feedback" title = "comments, pingbacks, trackbacks" class="comments">Feedback (2)</a> | Filed Under [
		<a id="_32e39ae98efa_HomePageDays_DaysList_ctl01_DayItem_DayList_ctl00_Categories_CatList_ctl01_Link" title="" href="/category/7.aspx">General</a>
	]

				</div>
			</div>
		

</div>
	
		
	<div class="day">
		<div class="date">
			<a id="_32e39ae98efa_HomePageDays_DaysList_ctl02_DayItem_ImageLink" title="Click to see entries for this day." title="Day Archive" href="/archive/2011/03/18.aspx" style="display:inline-block;">Friday, March 18, 2011</a>
		</div>
	
	
			<div class="post">
				<div class="title">
					<a id="_32e39ae98efa_HomePageDays_DaysList_ctl02_DayItem_DayList_ctl00_TitleUrl" title="Click To View Entry." href="/archive/2011/03/18/webgl-pong-is-alive.aspx">WebGl Pong is alive</a>
				</div>
				<div class="body">
					<p>I've spent the few spare hours I had going this week to get the different states sorted out that the game could be in, allowing it to be used as a game instead of just a local tech exercise.</p>
<p>It can be found at <a href="http://robashton.no.de">http://robashton.no.de</a> if you want to give it a go, because Websockets are disabled in most browsers for the moment you'll probably need flash installed for the network stuff (sorry, nothing I can do about that).</p>
<p><img width="500" height="358" alt="" src="/images/internal_codeofrob_com/glopng.png" /></p>
<p> </p>
<p>If you want to give it a whirl, I suggest you link it to a friend, as the site won't get enough traffic to make it worth waiting around for a random to turn up</p>
<p>The network code is a bit... inelegant, and that's one of the exercises for this weekend (doing it more 'proper').</p>
<p>The source for anybody interested in how it's been put together can be found on Github, although having made a beeline from 'okay code' to 'okay code with lots of crap bits' in order to 'ship', it's not a shining example of best practise.</p>
<p>I do so like finishing projects, although I wouldn't call this the end, next up is writing some better shaders, adding a particle system, switching back to a perspective projection matrix (so, putting the 3D back in), and probably adding a few little features that will make it more 'fun'.</p>
<p>Once I've exhausted all the learning opportunities Pong can give me (Amazing how something so simple can give so much), then I'll move onto the next WebGl project, using everything learned so far.</p>
				</div>
				<div class="info">
					posted @ <a href="/archive/2011/03/18/webgl-pong-is-alive.aspx" title = "Permanent link to this post">Friday, March 18, 2011 8:54 AM</a> | <a href="/archive/2011/03/18/webgl-pong-is-alive.aspx#feedback" title = "comments, pingbacks, trackbacks" class="comments">Feedback (2)</a> | Filed Under [
		<a id="_32e39ae98efa_HomePageDays_DaysList_ctl02_DayItem_DayList_ctl00_Categories_CatList_ctl01_Link" title="" href="/category/7.aspx">General</a>
	]

				</div>
			</div>
		

</div>
	
		
	<div class="day">
		<div class="date">
			<a id="_32e39ae98efa_HomePageDays_DaysList_ctl03_DayItem_ImageLink" title="Click to see entries for this day." title="Day Archive" href="/archive/2011/03/17.aspx" style="display:inline-block;">Thursday, March 17, 2011</a>
		</div>
	
	
			<div class="post">
				<div class="title">
					<a id="_32e39ae98efa_HomePageDays_DaysList_ctl03_DayItem_DayList_ctl00_TitleUrl" title="Click To View Entry." href="/archive/2011/03/17/a-javascript-game-loop-for-multiplayer-webgl.aspx">A Javascript game loop for multiplayer WebGL</a>
				</div>
				<div class="body">
					<p>In an aim to build that simple multi-player game (Pong), one of the first things to do to drive the application, is to build a game loop that will drive the rendering and logic.</p>
<p>We <i>were</i> building this at a hack day, so getting this set up was integral so we could split up the work in the team between building a basic renderer, and building the engine for doing all the pong logic (ping, pong, collision, etc ;-))</p>

<h2>First up, a Naive game loop</h2>

<script src="https://gist.github.com/874177.js?file=gistfile1.js"></script>

<p>There is something immediately wrong with this, and if you have ever gone remotely near Javascript you'll see it straight away.

</p><p>Chiefly, this is that you can't have never-ending loops in JS and expect the rest of the page to carry on functioning correctly.</p>

<p>As far as I understand it, Javascript effectively executes on a single UI thread, long-running calls to web services are done asynchronously (with callbacks executing on that single UI thread), and in order to get a loop running we have to fall back to getting a callback executed every time we want the loop to execute.</p>

<h2>Second up, another naive game loop</h2>

<script src="https://gist.github.com/874187.js?file=gistfile1.js"></script>

<p>In this attempt, we are saying "Run this logic 30 times a second", which is much better - as it means we render the scene 30 times a second and effectively execute the logic 30 times a second.</p>

<p>We might choose to stop here, except this is also problematic - as what happens if for _some_ reason on one client renderScene takes longer than a 30th of a second, but on another client it does not?</p>

<p>Poorly performing clients will quickly get out of sync with other clients who haven't got any problems - and in fact if you have any other timers, they might cause these ones to be queued... and well you get the picture. You can't trust that the logic is actually going to be called every 30th of a second.</p>

<p>One solution is to work out how much time has elapsed since the last frame, and use that as a multiplier in the executing logic (distanceTraveled = speed * timeElapsed) - but we can easily see that this would get out of hand in any but the simplest of rendering demos.</p>

<p>Nay, I present to you the loop we actually used in our pong game, this is based pretty much entirely from a post found on the excellent <a href="http://altdevblogaday.org/2011/02/23/ginkgos-game-loop/">AltDevBlogADay site</a></p>

<p>Don't worry if you can't read it easily, as I have a nice simple version of what it sets out to achieve below, in my less naive game loop</p>

<h2>A less naive approach</h2>

<script src="https://gist.github.com/874223.js?file=gistfile1.js"></script>

<p>It's a little bit more complicated, but what's we're essentially doing is de-coupling the execution of our logic from the underlying timer mechanism, by calculating how much time has elapsed since we last tried to run the logic, and then optionally run the logic more than once (or even not at all) if necessary.</p>

<p>We also keep the left over time around, to add to the next tick, so rounding errors don't bother us at all.</p>

<p>What's cool about this, is that we can store how many ticks has elapsed in the entire game, and use this as a universal value for coordinating synchronisation between two player's game states (more about this in the coming entries).</p>

<h2>Game programming 101</h2>
<p>Okay, so what the hell eh? I'm a software developer, not a game programmer, what am I doing writing posts about the most basic of games development topics? </p>

<p>Truth be told, I don't really know yet - but documenting what I've learned as I go along seems natural these days, and it's more interesting than Active Directory, which is what I'm currently learning about in my work hours...</p>

<p>Disclaimer: I'm not a games developer, and the loop above may not be optimal (although it does work!) - use it at your own peril.</p>
				</div>
				<div class="info">
					posted @ <a href="/archive/2011/03/17/a-javascript-game-loop-for-multiplayer-webgl.aspx" title = "Permanent link to this post">Thursday, March 17, 2011 11:28 AM</a> | <a href="/archive/2011/03/17/a-javascript-game-loop-for-multiplayer-webgl.aspx#feedback" title = "comments, pingbacks, trackbacks" class="comments">Feedback (11)</a> | Filed Under [
		<a id="_32e39ae98efa_HomePageDays_DaysList_ctl03_DayItem_DayList_ctl00_Categories_CatList_ctl01_Link" title="" href="/category/7.aspx">General</a>
	]

				</div>
			</div>
		

</div>
	
		
	<div class="day">
		<div class="date">
			<a id="_32e39ae98efa_HomePageDays_DaysList_ctl04_DayItem_ImageLink" title="Click to see entries for this day." title="Day Archive" href="/archive/2011/03/16.aspx" style="display:inline-block;">Wednesday, March 16, 2011</a>
		</div>
	
	
			<div class="post">
				<div class="title">
					<a id="_32e39ae98efa_HomePageDays_DaysList_ctl04_DayItem_DayList_ctl00_TitleUrl" title="Click To View Entry." href="/archive/2011/03/16/speaking-at-ndc2011.aspx">Speaking at NDC2011</a>
				</div>
				<div class="body">
					<p>I will be speaking in Norway in June at the <a href="http://www.ndc2011.no/">NDC conference</a></p>
<p><a href="http://www.ndc2011.no"><img height="95" width="271" alt="" src="/images/internal_codeofrob_com/ndc2011_logo.jpg" /></a><br />
</p>
<p>This is quite exciting for me, my experience of the northern european lot at <a href="http://oredev.org/2011">Oredev</a> was that they were all incredibly bright (Something to do with the cold weather maybe?), and while I am intending on attending that conference this year already (one way or another), the chance to go to another conference in the region is not one to be turned down</p>
<p>It also turns out that a lot of the people I know from the land of Twitter, London and other conferences will be going too, and I can't wait to drink some beers with them and catch up</p>
<p>The talks I'll be giving?</p>
<h2>Document databases and ASP.NET MVC</h2>
<p>The formal blurb is on the NDC website, but basically I'll be talking about how if you're coming from a background of using ORMs like NHibernate or EF4, how you can take what you've learned and apply it to document database usage in an ASP.NET MVC application</p>
<p>What's amusing for me about this one, is that once I'd used a document database in an ASP.NET MVC application, it actually changed how I used ORMs in my ASP.NET MVC applications too.</p>
<p>Simplicity is of course the aim of the day here, but I'll talk about some potentially complicated patterns that some people might feel more comfortable with if they're used to working in a particular way</p>
<p>So this will be a fun one, the talk will be largely agnostic when it comes to the document store we're actually using, and be applicable to both CouchDB and RavenDB (I guess begrudgingly Mongo as well, if you must)</p>
<h2>Introduction to RavenDB</h2>
<p>No conference should be without one of these right?</p>
<p>This will be a ground up introduction to what RavenDB is, the features it exposes and a quick look at the basic usage of it with the .NET API it ships with.</p>
<br />
<p>I'm looking forward to seeing everyone there, and hope we're able to fit in a sauna at some point (temporally, not physically, in case that needs clarifying)</p>
				</div>
				<div class="info">
					posted @ <a href="/archive/2011/03/16/speaking-at-ndc2011.aspx" title = "Permanent link to this post">Wednesday, March 16, 2011 3:21 PM</a> | <a href="/archive/2011/03/16/speaking-at-ndc2011.aspx#feedback" title = "comments, pingbacks, trackbacks" class="comments">Feedback (0)</a> | Filed Under [
		<a id="_32e39ae98efa_HomePageDays_DaysList_ctl04_DayItem_DayList_ctl00_Categories_CatList_ctl01_Link" title="" href="/category/7.aspx">General</a>
	 | 
		<a id="_32e39ae98efa_HomePageDays_DaysList_ctl04_DayItem_DayList_ctl00_Categories_CatList_ctl03_Link" title="" href="/category/13.aspx">RavenDb</a>
	]

				</div>
			</div>
		

</div>
	
		
	<div class="day">
		<div class="date">
			<a id="_32e39ae98efa_HomePageDays_DaysList_ctl05_DayItem_ImageLink" title="Click to see entries for this day." title="Day Archive" href="/archive/2011/03/14.aspx" style="display:inline-block;">Monday, March 14, 2011</a>
		</div>
	
	
			<div class="post">
				<div class="title">
					<a id="_32e39ae98efa_HomePageDays_DaysList_ctl05_DayItem_DayList_ctl00_TitleUrl" title="Click To View Entry." href="/archive/2011/03/14/why-webgl-and-node-js-and-websockets-are-important.aspx">Why WebGL and node.js (and websockets) are important</a>
				</div>
				<div class="body">
					<p>I've just moved to a new role in Belgium, and this means I've got time for some writing again, the popular vote on Twitter is that I blog my thoughts on these two cookies, and as they're what I'm currently ploughing my way through I can't help but pander to those requests.</p>


<p>If you're completely new to the wonderful world of these two technologies, then bear with me - this isn't that technical a post, and it might prompt you to read the next entries in the series coming up and maybe even dabble in it yourselves.</p>

<p><b>WebGl?</b></p>

<p> WebGL is a standard created to allow developers to embed a full on 3D accelerated experience inside the browser (using the canvas element), by developing against the already well known OpenGL API. It really is that simple - in Javascript, give us the method calls we're already used to in other languages to render our shiny stuff on screen.</p>

<p> And I really do mean shiny stuff, we are totally able to write our very own vertex and index shaders (mini-programs that run on the GPU across uploaded data) in HLSL (Again, the way we already know how) in order to create awesome shiny pieces of wonder ala this demo <a href="https://cvs.khronos.org/svn/repos/registry/trunk/public/webgl/sdk/demos/google/particles/index.html">here</a></p>:

<p><img src="http://codeofrob.com/images/internal_codeofrob_com/shinygl.png" height="422" width="564" /></p>

<p>Why is this great? It is a standard that browser vendors can implement (and already do, at least with Chrome, Firefox and Safari), allowing developers to create fully featured games (or applications, hah) that are cross platform right out of the box - and I don't just mean cross platform in terms of Apple/Windows/Linux here (Although that is <b>immense</b> in itself), I mean cross platform as in across all mobile devices as they begin to implement the standard too</p><p> (With Google pushing it into Chrome so fast, you'd better bet it'll end up on Android, and we'd hope that with Apple supposedly being all "pro standards" that they'd get it on the iPhone seeming as it already runs OpenGL).</p>

<p>That's right, games and rich applications that you can deliver from the internet to any client with a modern web browser - whether it be tablet, phone, laptop or desktop; there be gold in those there hills! </p>

<p>With local storage and the ability to save those pages and their dependencies to the hard drive we essentially also give them the ability to run off-line as desktop applications too. You can see that this is going to be a big thing as we move to more web-oriented computer systems (Google OS etc)</p>

<p><b>Node.js and Websockets<br /></b></p><p>If we're going to be writing our client code in Javascript, then it makes sense to go and write our server in the same language, allowing us to easily share code between the two. Websockets give us a great way of real-time communication with the web server. </p>

<p>They're currently disabled while they sort out security concerns, but the gap is serviced with socket.io allowing us to write code against whatever else is there and be forwards compatible for when they're enabled again. </p>

<p>Node.js, if you didn't know already, is a way to write completely non-blocking asynchronous code on the server (or desktop), hosted in Google's V8 Javascript engine (pretty darned fast).</p>

<p>It's ideal as a way of writing fast and efficient server code for communicating data between the clients connected via Websockets. It also has a large community and a great library of packages (data persistence, not a problem). It's also delightfully simple to use (A basic chat server and client in 15 lines of code?).</p>

<p>Oh, and the plans for web-sockets will allow p2p communication, so it's not like you have to place your entire load on a server either. I can see some very exciting things happening here the coming years.</p>

<p>This amazing set-up looks something like this:</p><p><img style="max-width: 800px;" src="http://codeofrob.com/images/internal_codeofrob_com/javascript.png" height="504" width="653" /></p>
<p>Hi guys, it's the future and this is what I look like.</p>

<p><b>Where I'm going with this<br /></b></p><p>What I'm trying to say is that with this combination of techno-wizardry, we have a way of easily deploying rich applications to potentially anybody on the planet, and provide a mechanism for getting them to communicate easily in real-time. This can all be easily developed in an already ubiquitous language, using frameworks we're readily familiar with and with a community that is growing at a vast rate of knots. </p>

<p>I know it's an oft-repeated statement, but the line between the desktop and web grows ever thinner, and it is swiftly becoming less relevant what the underlying platform actually is. With this, we move another step closer to the dream world of everybody being able to do anything anywhere. Hurrah!</p>

<p><b>The coming micro series of posts</b></p><p>Over the weekend, @<a href="http://twitter.com/ToJans">ToJans</a>, @<a href="http://twitter.com/seagile">Seagile</a> and I dived right into this technology stack, none of us are <i>really</i> Javascript developers and we made a few mistakes to begin with, but over the course of a day and a bit we managed to get the most amazing playable over the Internet game there is written.</p>

<p>It looked something like this:</p><p><img style="max-width: 800px;" src="http://codeofrob.com/images/internal_codeofrob_com/pong%201.png" /></p>

<p>Okay - I totally admit we could have done this with the plain old 2D acceleration with the HTML5 canvas (And that is a viable option for cross platform interactive applications too!!), but as a learning exercise we have to start somewhere, and WebGL 3D acceleration with an orthographic projection matrix is probably the simplest place we <i>can</i> start. </p>

<p>I'll be finishing it off and sticking it publicly on the Internet somewhere over the coming week before moving onto a more "real" project I have planned with the same technology, but in the coming posts I'll show you all what this actually looks like behind the scenes, how the technologies fit together and some patterns we used that kept our code clean(er) during this process. </p><p>Ace. Exciting. Super cool - all that.</p>
				</div>
				<div class="info">
					posted @ <a href="/archive/2011/03/14/why-webgl-and-node-js-and-websockets-are-important.aspx" title = "Permanent link to this post">Monday, March 14, 2011 10:24 PM</a> | <a href="/archive/2011/03/14/why-webgl-and-node-js-and-websockets-are-important.aspx#feedback" title = "comments, pingbacks, trackbacks" class="comments">Feedback (4)</a> | Filed Under [
		<a id="_32e39ae98efa_HomePageDays_DaysList_ctl05_DayItem_DayList_ctl00_Categories_CatList_ctl01_Link" title="" href="/category/7.aspx">General</a>
	]

				</div>
			</div>
		

</div>
	
		
	<div class="day">
		<div class="date">
			<a id="_32e39ae98efa_HomePageDays_DaysList_ctl06_DayItem_ImageLink" title="Click to see entries for this day." title="Day Archive" href="/archive/2011/02/02.aspx" style="display:inline-block;">Wednesday, February 02, 2011</a>
		</div>
	
	
			<div class="post">
				<div class="title">
					<a id="_32e39ae98efa_HomePageDays_DaysList_ctl06_DayItem_DayList_ctl00_TitleUrl" title="Click To View Entry." href="/archive/2011/02/02/service-location-is-always-evil.aspx">Service location is (not) always evil</a>
				</div>
				<div class="body">
					<p>Okay – so recently I’ve started presenting a session to various groups involving the well known IOC container “StructureMap” – and despite being pretty clear about the contents of said talk I’m getting quite a bit of backlash for demonstrating anything that even remotely resembles service location.</p> <p>As we all know, service location is bad – but why do we know that? Because we’ve been told it’s bad? And why were we told it was bad? Let’s very briefly dig into this and see where we end up:</p> <p><strong>Why is service location evil?</strong></p> <p>Consider the following WebForms style code:</p> <div id="codeSnippetWrapper"> <div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> Page</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">   {</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">       <span style="color: #0000ff">public</span> Page()</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">       {</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">           var factory = <span style="color: #0000ff">new</span> CheeseFactory();</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">           var cheese = factory.CreateCheese(<span style="color: #006080">"smelly"</span>);</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">       }</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">       <span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> BeginRequest()</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">       {</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">           var articles = DataAccess.GetArticles(100, 300);</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">           <span style="color: #008000">// Data binding</span></pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">       }   </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">   }</pre><!--CRLF--></div></div>
<p>This is the kind of un-testable code that we started moving towards using Dependency Injection to solve in languages that have the notion of strongly defined types and constructors and the means for doing such things. </p>
<p>We can immediately remove a coupling problem here and increase testability by injecting those dependencies via the constructor like so:</p>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> Page</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    {</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #0000ff">private</span> IDataAccess dataAccess;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #0000ff">public</span> Page(CheeseFactory cheeseFactory, IDataAccess dataAccess)</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        {</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">            var cheese = cheeseFactory.CreateCheese(<span style="color: #006080">"smelly"</span>);</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">            <span style="color: #0000ff">this</span>.dataAccess = dataAccess;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        }</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> BeginRequest()</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        {</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">            var articles = dataAccess.GetArticles(100, 300);</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">            <span style="color: #008000">// Data binding</span></pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        }</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    </pre><!--CRLF--></div>
<p>Okay, this isn’t necessarily the best example in the world (Simply moving our dependencies into the constructor to “improve testability and decrease coupling” isn’t the silver bullet everybody seems to think it is), but it serves to show the next snippet of code which our IOC containers are built to help us with:</p>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">var page = <span style="color: #0000ff">new</span> Page(</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">                <span style="color: #0000ff">new</span> CheeseFactory(),</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">                <span style="color: #0000ff">new</span> DataAccess(</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">                    <span style="color: #0000ff">new</span> Connection(<span style="color: #006080">"db://svr-db2"</span>)));</pre><!--CRLF--></div></div></div>
<p>With typical applications built on top of frameworks such as say, ASP.NET MVC – this dependency graph can become quite large in most typical systems built out of various service layers, repository layers, etc.  IOC containers popped into existence to make the above code more manageable like so:</p>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">var page = container.GetInstance&lt;Page&gt;();</pre><!--CRLF--></div></div>
<p>The aim from all this would be simply to be able to have a single call to container.GetInstance which would compose the entire application for us and we could carry on with just writing code and tests. </p>
<p>What we have here, are classes which up front specify their dependencies via their constructor arguments, which makes creating SUTs in our tests easier, and reduces ambiguity in our code base.</p>
<p>In certain circumstances due to bad design (For example, ASP.NET Webforms where we don’t actually have control over the creation of System.Web.Page), it becomes almost necessary to write code that looks something like this:</p>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> Page</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">{</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    <span style="color: #0000ff">private</span> IDataAccess dataAccess;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    <span style="color: #0000ff">private</span> CheeseFactory cheeseFactory;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> Initialize()</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    {</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #0000ff">this</span>.cheeseFactory = ObjectFactory.GetInstance&lt;CheeseFactory&gt;();</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #0000ff">this</span>.dataAccess = ObjectFactory.GetInstance&lt;DataAccess&gt;();</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        var cheese = cheeseFactory.CreateCheese(<span style="color: #006080">"smelly"</span>);</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    }</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> BeginRequest()</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    {</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        var articles = dataAccess.GetArticles(100, 300);</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #008000">// Data binding</span></pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    }</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">}</pre><!--CRLF--></div></div>
<p>In this example, we are making several calls out to the container to resolve some dependencies for our Page class – the problems with this are immediately obvious. These are hidden dependencies, we can’t know from looking at the class from the outside what it needs from the container, and testing will therefore get sticky and our system will be harder to maintain.</p>
<p>This, is service location, and this is evil – I’m not disagreeing with this and I think we’d be hard pushed to find anybody who thinks the above code is a good idea. When people say “Service location is evil”, they are thinking of the above example. </p>
<p>Here is another expression that tends to be shouted out quite loudly – “You should only be calling your container in one place in your application” – this expression has come because if you are using your IOC container for DI you should be able to construct your entire application from the “root” with a single request.</p>
<p><strong>Moving beyond using your IOC for DI</strong></p>
<p>Now here is the thing – modern IOC containers like StructureMap are moving beyond simply providing the facility to inject dependencies into our classes – they’re venturing into discovery territory, having the ability to automatically wire up concrete implementations to interfaces via convention is just the start of things – they can also be used to find all the implementations of say “IPlugin” and do something with them – this is an extension of their original purpose.</p>
<p>When I start using my IOC container to compose these plug-in systems, I do so because I want those plug-ins and their dependencies to also have the advantage of having their dependencies resolved and injected via their constructors without those implementers knowing how that works.</p>
<p>I could use MEF for some of this, but at this point I am already using a tool that will not only do a good job of discovery, but will also resolve all the dependencies set up in our boot-strapper - MEF as it currently stands does not make a good IOC container and its primary job is discovery which last time I checked was still worked via a WTF mess of attribute soup (I massively prefer those almighty conventions).</p>
<p>I therefore come to the following snippet of code taken from the RavenGallery project:</p>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> CommandInvoker : ICommandInvoker</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> {</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">     <span style="color: #0000ff">private</span> IContainer container;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">     <span style="color: #0000ff">private</span> IDocumentSession documentSession;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">     <span style="color: #0000ff">public</span> CommandInvoker(IContainer container, IDocumentSession documentSession)</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">     {</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">         <span style="color: #0000ff">this</span>.container = container;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">         <span style="color: #0000ff">this</span>.documentSession = documentSession;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">     }</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">     <span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> Execute&lt;T&gt;(T command)</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">     {</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">         var handler = container.GetInstance&lt;ICommandHandler&lt;T&gt;&gt;();</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">         handler.Handle(command);</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">         documentSession.SaveChanges();</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">     }</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> }</pre><!--CRLF--></div></div>
<p>(Ignoring that this command handler is also in charge of the Unit of Work), the takeaway point is that I’m passing in the container and using it to find a command handler for the command that has been passed in. </p>
<p>Standard stuff really, so if I pass in a comand where T is RegisterNewUserCommand ala</p>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> RegisterNewUserCommand</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">{</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> Username</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    {</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        get;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #0000ff">private</span> set;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    }</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> Password</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    {</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        get;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #0000ff">private</span> set;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    }</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    <span style="color: #0000ff">public</span> RegisterNewUserCommand(<span style="color: #0000ff">string</span> username, <span style="color: #0000ff">string</span> password)</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    {</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #0000ff">this</span>.Username = username;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #0000ff">this</span>.Password = password;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    }</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">}</pre><!--CRLF--></div></div>
<p>Then the following type will be resolved</p>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> RegisterNewUserCommandHandler : ICommandHandler&lt;RegisterNewUserCommand&gt;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">{</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    <span style="color: #0000ff">private</span> IUserRepository userRepository;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    <span style="color: #0000ff">public</span> RegisterNewUserCommandHandler(IUserRepository userRepository)</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    {</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #0000ff">this</span>.userRepository = userRepository;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    }</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> Handle(RegisterNewUserCommand command)</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    {</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        User newUser = <span style="color: #0000ff">new</span> User(command.Username, command.Password);</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        userRepository.Add(newUser);</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    }</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">}</pre><!--CRLF--></div></div>
<p>And all because in my StructureMap configuration I called</p>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">s.ConnectImplementationsToTypesClosing(<span style="color: #0000ff">typeof</span> (ICommandHandler&lt;&gt;));</pre><!--CRLF--></div></div>
<p><strong>Hold on, that’s service location!! You’re calling into the container directly!!</strong></p>
<p>Yes, and you know what – I still sleep well at night.</p>
<ul>
<li>I could I guess have the equivalent to MEFs [ImportMany] on my invoker (urgh) </li>
<li>I could write the code to resolve those implementers myself (A potentially non-trivial task) </li>
<li>I could wrap up IContainer with my own type (Not worth it) </li></ul>
<p>Going back to our example of <em>why</em> service location is bad, this example has nothing to do with that. When using your IOC container for nothing beyond plain old DI then sure – 99.999% of the time you’re doing it wrong if you end up with service location – but when you move into the territory of using the IOC container for discovery and run-time resolution there is little to no benefit to trying to work around a call into the container which – by the way – does a really good job of it already.</p>
<p>At this point we’re in the glue of our application, our infrastructure and we’re using the container as another piece of infrastructure – not as a workaround to avoid injecting our dependencies explicitly.</p>
<p>This is elegant and just works, I don’t think the “rule” applies in this kind of situation and I’m not the only one who seems to thinks so.</p>
<p>There is a difference in my mind therefore, between service location and dynamic dependency resolution. (Feel free to give me some proper words to put in here folks, my terminology-fu is <em>weak</em>)</p>
<p><strong>A side note – ASP.NET MVC3</strong></p>
<p>There are some complaints that ASP.NET MVC uses the container as a service locator – primarily because a single web request results in quite a few calls to the container from all over the place. This occurs because support for it has just been bolted on as an afterthought to appease the masses who complained that various aspects of ASP.NET MVC were untestable.</p>
<p>It’s not <em>quite</em> the same thing as this, there are a number of places in the framework where had the framework been built around the notion of composition in the first place we wouldn’t need all those calls – but really, I can’t say I have too huge a problem with this either, it’s not an awful compromise around a framework that has already gone down an awkward path and has needed to rectify it in a simple and backwards compatible a manner as possible. </p>
<p><strong>Another side note</strong></p>
<p>I’m not entirely sure that creating our entire application hierarchy with an IOC container is actually a Good Thing, and I’m moving away from it in my more recent explorations – but that’s a discussion best left to the GOOS group and for another time.</p>
				</div>
				<div class="info">
					posted @ <a href="/archive/2011/02/02/service-location-is-always-evil.aspx" title = "Permanent link to this post">Wednesday, February 02, 2011 2:45 PM</a> | <a href="/archive/2011/02/02/service-location-is-always-evil.aspx#feedback" title = "comments, pingbacks, trackbacks" class="comments">Feedback (8)</a> | Filed Under [
		<a id="_32e39ae98efa_HomePageDays_DaysList_ctl06_DayItem_DayList_ctl00_Categories_CatList_ctl01_Link" title="" href="/category/7.aspx">General</a>
	]

				</div>
			</div>
		

</div>
	
		
	<div class="day">
		<div class="date">
			<a id="_32e39ae98efa_HomePageDays_DaysList_ctl07_DayItem_ImageLink" title="Click to see entries for this day." title="Day Archive" href="/archive/2011/01/31.aspx" style="display:inline-block;">Monday, January 31, 2011</a>
		</div>
	
	
			<div class="post">
				<div class="title">
					<a id="_32e39ae98efa_HomePageDays_DaysList_ctl07_DayItem_DayList_ctl00_TitleUrl" title="Click To View Entry." href="/archive/2011/01/31/my-ddd9-experience-and-slides-from-my-talks.aspx">My DDD9 Experience (and slides from my talks)</a>
				</div>
				<div class="body">
					Saturday saw the 9th Developer Developer Developer community event happen at the Microsoft Campus in Reading, a free event that only 350 people can fit into, and which "sold out" in 12 minutes (A number that keeps going down year by year).<br />
<br />
The sheer number of talks submitted this year meant there was some real competition for spaces as speakers as well - which resulted in probably the best selection of talks I can remember in DDD history.<br />
<br />
The sessions I attended were:<br />
<br />
<span style="font-weight: bold;">Async C#5 with Liam Westley</span><br />
An unusual choice for me, I usually avoid "new X in Y" sessions like the plague, as by the time the features actually come out I'm already bored of them and don't end up taking the time to work out what's actually changed in the finished version. I've not really touched the Async bits though and having not yet seem Liam talk and the other interesting alternative being Gary Short who I've seen far too many times (more than once) made this the obvious choice.<br />
<br />
This was a well rehearsed session, and I took away a few things - primarily that I can't have a problem with how async has been implemented if I like the yield keyword (and I like the yield keyword), and that it is more to do with dealing with avoiding blocking operations than managing thread complexity (or something to that end). Also that apparently the biggest debate apparently revolves around what name the keywords should have...<br />
<br />
<br />
<span style="font-weight: bold;">Monads with Mike Hadlow</span><br style="font-weight: bold;" />
Mike has been rattling on about Monads on his blog for a while now, and I've avoided reading it because I knew he was going to come talk about them at DDD9 - this was definitely my kind of talk and I've come away knowing what Monads are in computer science terms, although I'm still struggling to see why I'd want the overhead of dealing with them directly outside of LINQ in C# I'll be going back and checking out his blog to find out. <br />
<br />
<span style="font-style: italic;">Shocking confession, gasp - I didn't know what monads were - a crime I'm sure!</span><br />
<br />
<span style="font-weight: bold;">RavenDB with Rob Ashton</span><br />
I'm actually quite disappointed with the way the session turned out - given how many times I've given this talk I should have done better, it didn't feel quite <span style="font-style: italic;">right</span> for some reason - and I rather wished I'd been next door to hear Mark Rendle talk about some of the crazy things he's doing in C#· :-)<br />
<br />
<span style="font-style: italic;">Lunch</span><span style="font-weight: bold;"> </span><span style="font-style: italic;">Grok Talks</span><br />
I like grok talks, I didn't realise how short lunch was and I thought they needed some padding so I proposed a talk on CUDA, turns out I needn't have bothered as we actually ran out of time to get through them all.<br />
<br />
<span style="font-weight: bold;">Some silverlight stuff with Visio with Dave McHahon</span><br />
I didn't see any silverlight in this grok, so I guess I must have missed that - I did see some data driven stuff you can do with visio which apparently is fun if you're into such things ;-). I learned that it is possible so I count that as a win.<br />
<br />
<span style="font-weight: bold;">A grok to CUDA C with Rob Ashton</span><br />
I tried to cover everything I knew about CUDA C in 5 minutes, I kept asking how many people were following me over the 5 minutes and it was entertaining to watch the hands drop over time - I've submitted a full on hour of this to DDD Scotland if people are interested in seeing it done at a slower pace ;-)<br />
<br />
<span style="font-weight: bold;">IronRuby with Windows Phone 7 with @slodge</span><br />
This is just a cool topic - not relevant to me at all - but really good to see somebody talking about something like this!<br />
<br />
After lunch, it was back to the normal sessions:<br />
<br />
<span style="font-weight: bold;">What's new with ASP.NET MVC 3 with Andy Gibson</span><br />
I can't say I left this talk excited about ASP.NET MVC 3 - but that's more of an indication of my feelings towards the technology than the talk itself which was great<br />
<br />
I didn't actually attend the next session, I needed a break and drifted between the various sessions looking in from behind - I spent most of my time in <span style="font-weight: bold;">Colin Gemmell's .NET to Rails story, </span>which was superbly presented from the look of things, enthusiastic and well put across.<br />
<br />
<span style="font-weight: bold;">Introduction to Powershell with James Boother</span><br />
I don't tend to do Powershell, if I do any sort of scripting it's generally with shell script or Python - but it was nice to see why people are enthusiastic about Powershell - although the verbosity of some of the commands left me a bit scared - what's wrong with plain old tail -f? ;-)<br />
<br />
Anyway, that was a superb day, I can't believe all those sessions actually fitted into a single Saturday <span style="font-weight: bold;"><span style="font-style: italic;">and</span> <span style="font-weight: bold;" /></span>was free. Here is to DDD10 being an equally excellent event. Congratulations to all who were involved in the organisation - very slick.<br />
<br />
<span style="font-weight: bold;">My slides and example code</span><br />
I've uploaded them to <a href="https://github.com/robashton/talks/tree/master/DDD9">https://github.com/robashton/talks/tree/master/DDD9</a>
				</div>
				<div class="info">
					posted @ <a href="/archive/2011/01/31/my-ddd9-experience-and-slides-from-my-talks.aspx" title = "Permanent link to this post">Monday, January 31, 2011 11:59 AM</a> | <a href="/archive/2011/01/31/my-ddd9-experience-and-slides-from-my-talks.aspx#feedback" title = "comments, pingbacks, trackbacks" class="comments">Feedback (2)</a> | Filed Under [
		<a id="_32e39ae98efa_HomePageDays_DaysList_ctl07_DayItem_DayList_ctl00_Categories_CatList_ctl01_Link" title="" href="/category/7.aspx">General</a>
	 | 
		<a id="_32e39ae98efa_HomePageDays_DaysList_ctl07_DayItem_DayList_ctl00_Categories_CatList_ctl03_Link" title="" href="/category/13.aspx">RavenDb</a>
	 | 
		<a id="_32e39ae98efa_HomePageDays_DaysList_ctl07_DayItem_DayList_ctl00_Categories_CatList_ctl05_Link" title="" href="/category/14.aspx">CUDA</a>
	]

				</div>
			</div>
		

</div>
	
		
	<div class="day">
		<div class="date">
			<a id="_32e39ae98efa_HomePageDays_DaysList_ctl08_DayItem_ImageLink" title="Click to see entries for this day." title="Day Archive" href="/archive/2011/01/26.aspx" style="display:inline-block;">Wednesday, January 26, 2011</a>
		</div>
	
	
			<div class="post">
				<div class="title">
					<a id="_32e39ae98efa_HomePageDays_DaysList_ctl08_DayItem_DayList_ctl00_TitleUrl" title="Click To View Entry." href="/archive/2011/01/26/ravendb-vs-mongodb-why-i-dont-usually-bother.aspx">RavenDB vs MongoDB - Why I don't usually bother</a>
				</div>
				<div class="body">
					<p>I’m constantly asked at my talks and around various community events what the differences between MongoDB and RavenDB are - and when I made a small blog series describing the differences between RavenDB and CouchDB, I was lambasted for deciding that it wasn’t worth my time to cover MongoDB  - so here we go, let’s talk about this.</p> <p>In order to talk about Mongo and Raven, we first need to look at reasons we might choose to ditch our relational database to move to any of the alternative data stores, this is simple – but surprisingly people seem to skip the obvious and stick NoSQL in one imaginary group marked “scalability” and “not for us”. So let’s do a little bit of catch-up before I begin the comparisons.</p> <ul> <li>Relational databases are pieces of mature software that are used as a one size fits all solution </li> <li>NoSQL data stores are <em>typically</em> geared towards a specific sweet spot, and make sacrifices in other areas in order to do that one thing well </li></ul> <p>Simple really - let’s look at an example of this -  <strong><em>Solr</em></strong>, a HTTP server built around Lucene.</p> <p>A lot of us are already using this, and were using it long before the current “nosql fad” hit.  When writing search into our applications we have a choice – we can use the full text indexing services in our standard database (which can be clunky, technologically awkward and basically keeps the DBA happy), or we can give this job to something that does search well.</p> <p>Solr doesn’t really do transactions (although there is a commit, it is global in nature), it doesn’t do relationships, it just does flattened documents on which you can perform full-text searches, it also has fantastic horizontal scaling support.  It isn’t really geared towards being a primary data store but excels at what it <em>is</em> designed for, which is adding fully-featured search support to applications.</p> <p>Another example of this: contrary to popular belief, Facebook doesn’t use Cassandra for much more than messages between inboxes – instead running most of their data stores off a intelligently partitioned MySQL set-up (because it works, albeit they have had to think very carefully about how they do that).</p> <p>It’s all about sweet spots -  if you have a problem that needs solving – then as a developer you want to first try to find a way to solve that problem without writing any code, and then if you really have to, solve the problem with as little code as possible and in as an efficient manner as possible.</p> <p>This brings us back to our main three contenders for primary data stores in an OLTP environment (which is what most of us work in), Couch, Raven and Mongo, where are their sweet spots? Let’s look at some main data points across those three and then ask that question again</p> <p><strong>CouchDB</strong></p> <ul> <li>Transactions: Atomic writes per document (bulk operations are not atomic) </li> <li>Consistency: Strong node/eventual cluster (Views are updated when you read from them) </li> <li>Writing: Always write entire documents </li> <li>Reading: Always “querying” materialised views </li> <li>Set-based operations: Nil </li> <li>Durability: About as durable as it gets </li> <li>Ad-hoc queries: Nil </li> <li>“Joins”: You can pull entire documents down with a single HTTP request (not projections) </li> <li>Tech: HTTP Rest API with JSON docs</li></ul> <ul> <li>Summary: Fast writes, fast-ish reads, </li></ul> <p><strong>RavenDB</strong></p> <ul> <li>Transactions: Atomic bulk operations, supported across server-instances </li> <li>Consistency: Eventual (Views are updated in the background) </li> <li>Writing: Typically write entire documents </li> <li>Reading: Always “querying” materialised views </li> <li>Set-based operations: Updates/Deletes </li> <li>Durability: Effectively a transaction log, data is either written or it is not written </li> <li>Ad-hoc queries: Indexes can be created/managed automatically based on ad-hoc queries </li> <li>“Joins”: Post-query, properties from related documents can be loaded into a projection (live projections) </li> <li>Tech: HTTP Rest API with JSON docs </li> <li>Summary: Fast writes, fast reads, stale data from views is allowed</li></ul> <p><strong>MongoDB</strong></p> <ul> <li>Transactions: Atomic writes per document </li> <li>Consistency: Strong master/eventual slave (No pre-computed views) </li> <li>Writing: Amazing array of possibilities, all blindingly fast </li> <li>Reading: Very similar to queries in a relational DB, except querying docs, not tables </li> <li>Set-based operations: Nil </li> <li>Durability: At the moment, power goes out, you lose data, in 1.8 we get a transaction log </li> <li>Ad-hoc queries: Sure, but if you want performance you’re going to have to add indexes to your documents </li> <li>“Joins”: Nil </li> <li>Tech: Custom TCP protocol with JSON docs</li> <li>Summary: Blindingly fast writes (potentially to a black hole), traditional query-based read-model </li></ul> <p>Anyway, that’s the pointless and missing-a-lot-of-the-salient-points feature comparison out the way and done with, I’ll instead now give my very abstract views over the three:</p> <p><strong>RavenDB</strong></p> <p>RavenDB is feature heavy, has separate read/write stores (documents = write store, indexes = query store), and a “fast is fast enough approach” to performance considerations. While most operations <em>have</em> been profiled and tweaked, most of the performance gains in OLTP applications come from the materialized map or map/reduce views (pre-computed queries). There is a massive drive towards usability with this project and it shows.</p> <p><strong>CouchDB</strong>:</p> <p>CouchDB is a feature-lite but but more mature brother to RavenDB and as such has separate read/write stores (documents = write store, views = query store), a more pure approach to achieving performance targets and apparently one of their big priorities is the ability to run on as many platforms as possible. Worth noting that performance is gained in a similar manner to RavenDB, by effectively performing pre-computed queries using map or map/reduce</p> <p><strong>MongoDB</strong>: Feature-lite, very similar to a traditional database in that you store documents, and add indexes to fields in those documents which make queries over those documents faster (indexes effectively mean data from those documents are stored in some cool data structures in memory-mapped files). Performance is entirely gained by micro-optimising every level of this pipeline (so it uses TCP directly, not HTTP, connection pooling in all their platform drivers (APIs are generally written on top of these drivers)), and writing every bit of code to run as fast as it possibly can.</p> <p><strong>Where I stand</strong></p> <p>So, given the above, we can see that Raven and Couch are very different to our traditional databases – they have a big drive towards making reads cheap - and because in most applications we tend to do more reads than writes and we generally know what queries we’re going to be making in advance, setting them all up as materialized views (whether automatically in the case of Raven, or manually in the case of Couch) just makes sense. </p> <p>The biggest thing for both of these (and Raven in particular) is not that they’re fast, or scalable – it is that they are both incredibly usable because they give us a structured framework for creating a basic CQRS principled OLTP application without having to worry about mapping or query plans or complex architectures or DBAs who think that SPROCs are the one and only way to do things. They enable us to build applications that work _fast_, and that’s what is important to our customers. This is a sweet spot.</p> <p><strong>Let’s talk about Mongo then</strong></p> <p>Mongo on the other hand, is very similar to our traditional databases – with the core difference that data is stored as documents instead of being split out (normalised) across multiple tables. The rest of it all looks very similar – except we lose the ability to do joins across our tables (so complex reporting is out). Reads are fast, but only because Mongo has been micro-optimised to the hilt (just like most database engines), writes are fast, but only because the system doesn’t wait to find out if writes have been successful before carrying on with the next job.</p> <p>I don’t see it, I don’t see the sweet spot – even if the durability issues are sorted out it’s still just a traditional database with a few less features in the name of gaining a few milliseconds that most of us don’t need.</p> <p>It achieves fast query speed by storing indexes in memory, which means what Mongo actually gives us is a really slow way to query in memory objects – and heaven forbid you run out of enough RAM to store these indexes on your production servers (ala Foursquare a few months ago). If you’re  going to go for an in-memory query store then you’re probably going to use Redis because that’s <em>its</em> sweet spot…</p> <p>As a consequence of this, when asked to compare Raven and Mongo, I find it generally hard to answer the question because they are fundamentally very different animals (is Mongo even an animal?), and even lengthy blog entries like this don’t come close to scratching the surface of the differences between the data stores. </p> <p>In my honest opinion, there are no problems that Mongo solve that the either Couch, Raven or even MySQL don’t already solve better – there is no sweet spot apart from maybe as a really fast logging system – and even then I might debate that point because I value my logs and don’t want to lose them to a random power outage.</p> <p>Hopefully I’ve explained myself here – it’s not that I dislike Mongo, I just don’t see the point of it – I don’t see what it brings to the table and I don’t see a sweet spot – and I think that a lot of people using it <em>instead</em> of Couch or Raven don’t really have any credible reasons for moving away from a relational store in the first place.</p> <p>Using Mongo instead of Raven or Couch is like buying the fastest most tuned up car you can afford, and then only driving it in reverse when you arrive at the races.</p> <p><em>Fin</em></p>
				</div>
				<div class="info">
					posted @ <a href="/archive/2011/01/26/ravendb-vs-mongodb-why-i-dont-usually-bother.aspx" title = "Permanent link to this post">Wednesday, January 26, 2011 4:58 PM</a> | <a href="/archive/2011/01/26/ravendb-vs-mongodb-why-i-dont-usually-bother.aspx#feedback" title = "comments, pingbacks, trackbacks" class="comments">Feedback (10)</a> | Filed Under [
		<a id="_32e39ae98efa_HomePageDays_DaysList_ctl08_DayItem_DayList_ctl00_Categories_CatList_ctl01_Link" title="" href="/category/7.aspx">General</a>
	 | 
		<a id="_32e39ae98efa_HomePageDays_DaysList_ctl08_DayItem_DayList_ctl00_Categories_CatList_ctl03_Link" title="" href="/category/12.aspx">NoSql</a>
	 | 
		<a id="_32e39ae98efa_HomePageDays_DaysList_ctl08_DayItem_DayList_ctl00_Categories_CatList_ctl05_Link" title="" href="/category/13.aspx">RavenDb</a>
	]

				</div>
			</div>
		

</div>
	
		
	<div class="day">
		<div class="date">
			<a id="_32e39ae98efa_HomePageDays_DaysList_ctl09_DayItem_ImageLink" title="Click to see entries for this day." title="Day Archive" href="/archive/2011/01/21.aspx" style="display:inline-block;">Friday, January 21, 2011</a>
		</div>
	
	
			<div class="post">
				<div class="title">
					<a id="_32e39ae98efa_HomePageDays_DaysList_ctl09_DayItem_DayList_ctl00_TitleUrl" title="Click To View Entry." href="/archive/2011/01/21/cuda-a-basic-parallelised-task.aspx">CUDA - A basic parallelised task</a>
				</div>
				<div class="body">
					<p>Source for this entry can be found at: <a href="https://github.com/NeilRobbins/CudaHack/tree/master/arrayscalar">https://github.com/NeilRobbins/CudaHack/tree/master/arrayscalar</a></p>

<p>In the last post, I demonstrated that you had</p> <ul> <li>System memory which is not accessible to the GPU </li> <li>Device memory which is not accessible to  the CPU </li> <li>User defined methods marked with __global__ called from the CPU to run on the device </li></ul> <p>We called that method and executed some code on the server to do a really trivial task - giving us no benefit at all (apart from perhaps treating the GPU as "yet another CPU" in our machine).</p> <p>The GPU is NOT just an additional CPU though, it has an entirely different architecture (to my understanding), which effectively boils down to that it was originally created for the single purpose of being able to perform a series of mathematical operations on a large set of data in parallel. </p> <p>Let’s take a trivial example, again on the CPU:</p> <div id="codeSnippetWrapper"> <div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"><span style="color: #0000ff">void</span> multiplyNumbersByAScalar(<span style="color: #0000ff">float</span>[] numbers, <span style="color: #0000ff">int</span> length, <span style="color: #0000ff">float</span> scalar)</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">{</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    <span style="color: #0000ff">for</span>(<span style="color: #0000ff">int</span> x = 0 ; x &lt; length ; x++){</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        numbers[x] = numbers[x] * scalar;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    }</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">}</pre><!--CRLF--></div></div>

<p>The key aspect of this operation to note, is that each result in that array is achieved independently of any others – that is, instead of performing a loop in serial, this task could easily be parallelised. In C# it looks something like this:</p>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">numbers.AsParallel().Select(x=&gt; x * scalar).ToArray();</pre><!--CRLF--></div></div>
<p>The problem with the above, is that it is only taking advantage of the CPU, and the benefits very seldom outweigh the overhead of setting up the parallel operation in the first place. Parallelisation is only really useful when you have sets of data large enough to justify it, and hardware capable of massively parallelising that task rather than say, creating 2-3 threads for it. </p>
<p>Anyway, as in the last entry, let’s slowly start to modify this method and get it running on the GPU, first up let’s look at how we’re actually going to invoke this method – this is what it looks like in our CPU implementation:</p>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"><span style="color: #0000ff">float</span> numbers[] = { 0, 1, 2, 3, 4, 5 };</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">multiplyNumbersByAScalar( numbers, 6, 2.0f );</pre><!--CRLF--></div></div>
<p>First thing of note, is that we can’t pass numbers into our GPU implementation when we write it, it is declared in system memory – so our first job is to create a buffer on the device and copy our original data into that buffer:</p>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"><span style="color: #0000ff">float</span> numbersInSystemMemory[] = { 0, 1, 2 , 3 , 4 , 5 , 6 ,7 ,8 , 9};</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"><span style="color: #0000ff">float</span>* numbersInDeviceMemory;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"><span style="color: #008000">// Allocate some memory on the device</span></pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">cudaMalloc( (<span style="color: #0000ff">void</span>**)&amp;numbersInDeviceMemory, <span style="color: #0000ff">sizeof</span>(<span style="color: #0000ff">float</span>) * 10);</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"><span style="color: #008000">// And upload our data from system memory to device memory</span></pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">cudaMemcpy( numbersInDeviceMemory, numbersInSystemMemory, <span style="color: #0000ff">sizeof</span>(<span style="color: #0000ff">float</span>) * 10, cudaMemcpyHostToDevice );</pre><!--CRLF--></div></div>
<p>Next thing up, is something we glossed over in the last entry – the numbers inside the strange &lt;&lt;&lt;1,1&gt;&gt;&gt; syntax for invoking the global method.</p>
<p>Without going into too much detail, it is this syntax and those numbers that determine first</p>
<ul>
<li>How many “blocks” to separate the task into</li>
<li>How many “threads” to use per “block”</li></ul>
<p>Ignoring threads for now, a  good first step would be to say that as we have 10 numbers, we can split our operation across 10 blocks, and parallelise it that way, like so:</p>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">multiplyNumbersByAScalar&lt;&lt;&lt;10,1&gt;&gt;&gt;(numbersInDeviceMemory, 2.0f);</pre><!--CRLF--></div></div>

<p>Now, you’ll notice I’ve dropped the “length” parameter into the function call – and that’s because we need to perform a small change to our original method definition. </p>
<p>In our CPU implementation, the method itself was responsible for iterating through the array and performing the calculations – in our GPU implementation, the iteration task has been replaced by a parallelisation task and the GPU is  going to be responsible for calling our method however many times (per block/thread) is necessary, so check this out:</p>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">__global__ <span style="color: #0000ff">void</span> multiplyNumbersByAScalar(<span style="color: #0000ff">float</span> numbers[], <span style="color: #0000ff">float</span> scalar) {</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #0000ff">int</span> x = blockIdx.x;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        numbers[x] = numbers[x] * scalar;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">}</pre><!--CRLF--></div></div>

<p>First up, we already know about __global__ as a way of allowing our CPU code to invoke GPU code, what <em>should</em> stand out here is we have gotten ‘x’ from a magical local variable that hasn’t actually been declared anywhere. This is another NVCC peculiarity, and this has come from the numbers we used inside the angle brackets in order to set up the call in the first place.</p>
<p>The method will get called 10 times, with x being every value between 0 and 9 inclusive – and in parallel. Because we told it to.</p>
<p>BlockIdx is actually a vector, containing x y and z – and that gives us the ability to divide up our parallel operation in a multitude of ways that make sense to our logic – I’ll talk more about that in the coming entries.</p>
<p>Our entire program therefore looks something like this:</p>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">__global__ <span style="color: #0000ff">void</span> multiplyNumbersByAScalar(<span style="color: #0000ff">float</span> numbers[], <span style="color: #0000ff">float</span> scalar) {</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #008000">// So yeah, this magic variable is given to us by CUDA magic</span></pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #0000ff">int</span> x = blockIdx.x;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        numbers[x] = numbers[x] * scalar;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">}</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"><span style="color: #0000ff">int</span> main(<span style="color: #0000ff">int</span> argc, <span style="color: #0000ff">char</span>** args)</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">{</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #0000ff">float</span> numbersInSystemMemory[] = { 0, 1, 2 , 3 , 4 , 5 , 6 ,7 ,8 , 9};</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #0000ff">float</span>* numbersInDeviceMemory;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #008000">// Allocate memory on the device and upload our data to it</span></pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        cudaMalloc( (<span style="color: #0000ff">void</span>**)&amp;numbersInDeviceMemory, <span style="color: #0000ff">sizeof</span>(<span style="color: #0000ff">float</span>) * 10);</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        cudaMemcpy( numbersInDeviceMemory, numbersInSystemMemory, <span style="color: #0000ff">sizeof</span>(<span style="color: #0000ff">float</span>) * 10, cudaMemcpyHostToDevice );</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #008000">// Call the method 10 times with values of x between 0 and 9 inclusive</span></pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        multiplyNumbersByAScalar&lt;&lt;&lt;10,1&gt;&gt;&gt;(numbersInDeviceMemory, 2.0f);</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #008000">// Copy the results back into system memory</span></pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        cudaMemcpy(  numbersInSystemMemory, numbersInDeviceMemory, <span style="color: #0000ff">sizeof</span>(<span style="color: #0000ff">float</span>) * 10, cudaMemcpyDeviceToHost );</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #008000">// And free the memory allocated</span></pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        cudaFree( numbersInDeviceMemory );</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #008000">// Standard C again</span></pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #0000ff">for</span>(<span style="color: #0000ff">int</span> x = 0; x &lt; 10 ; x++){</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">                printf(<span style="color: #006080">"%f "</span>, numbersInSystemMemory[x]);</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        }</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"> </pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #0000ff">return</span> 1;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">}</pre><!--CRLF--></div></div>
Maximum value of x by the way, on my laptop is 65536 – now <em>that’s</em> what I call splitting my task up and parallelising it. On really large data sets having this kind of functionality is really powerful.
				</div>
				<div class="info">
					posted @ <a href="/archive/2011/01/21/cuda-a-basic-parallelised-task.aspx" title = "Permanent link to this post">Friday, January 21, 2011 2:27 PM</a> | <a href="/archive/2011/01/21/cuda-a-basic-parallelised-task.aspx#feedback" title = "comments, pingbacks, trackbacks" class="comments">Feedback (1)</a> | Filed Under [
		<a id="_32e39ae98efa_HomePageDays_DaysList_ctl09_DayItem_DayList_ctl00_Categories_CatList_ctl01_Link" title="" href="/category/7.aspx">General</a>
	 | 
		<a id="_32e39ae98efa_HomePageDays_DaysList_ctl09_DayItem_DayList_ctl00_Categories_CatList_ctl03_Link" title="" href="/category/14.aspx">CUDA</a>
	]

				</div>
			</div>
		

</div>
	


				
				<div class="clearer">&nbsp;</div>
			</div>   
		</div>
	</div>
	
	<div id="footer">
		
	<div class="copyright">
		Copyright &copy; 2011 Rob Ashton
	</div>

	</div>
</div>
		

<script type="text/javascript">
//<![CDATA[
document.getElementById('Form1').action = window.location.href;
Sys.Application.initialize();
//]]>
</script>
</form>
	    <script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-11207442-1");
pageTracker._setDomainName(".codeofrob.com");
pageTracker._trackPageview();
} catch(err) {}</script>
	    <div id="stylesheetTest"></div>
	</body>
</html>
